<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architect | Agents on Tasks</title>
    
    <!-- Stable CDN Links -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            background-image: radial-gradient(circle at top right, rgba(99, 102, 241, 0.05), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(168, 85, 247, 0.05), transparent 40%);
        }

        .premium-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .textarea-premium {
            width: 100% !important;
            height: 140px !important;
            min-height: 100px;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
            line-height: 1.6;
            resize: vertical;
            transition: all 0.2s ease;
            display: block;
        }

        .textarea-premium:focus {
            outline: none;
            border-color: #6366f1; /* primary color */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .input-premium {
            width: 100% !important;
            height: 3.5rem;
            padding: 0 1rem 0 3rem;
            border-radius: 0.75rem;
            border: 1px solid #d1d5db;
            font-weight: 600;
            display: block;
        }

        .input-premium:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .CodeMirror {
            height: 500px;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            padding: 10px;
            border-radius: 0 0 1rem 1rem;
        }

        .code-editor-container {
            margin-top: 2.5rem;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .code-toolbar {
            background: #f9fafb;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tool-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 700;
            color: #4b5563;
            transition: all 0.2s;
            text-decoration: none;
        }

        .tool-badge:hover {
            border-color: #6366f1;
            color: #6366f1;
            transform: translateY(-1px);
        }

        .hero-gradient {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>

<body class="min-h-screen py-12 px-4 selection:bg-indigo-100 pt-20">
    <!-- Branding Clip -->
    <a href="{% url 'agentoapp:index' %}" class="fixed top-0 left-1/2 -translate-x-1/2 z-[100] group">
        <div class="bg-white px-8 py-3 rounded-b-3xl shadow-[0_10px_30px_-5px_rgba(0,0,0,0.1)] border-x border-b border-gray-100 flex items-center gap-3 animate-in slide-in-from-top duration-700 group-hover:bg-gray-50 transition-colors">
            <i class="bi bi-robot text-indigo-600 text-xl"></i>
            <span class="font-black tracking-[0.2em] text-gray-800 text-xs uppercase">Agentollama</span>
        </div>
    </a>
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-6 px-2">
            <div>
                <div class="flex items-center gap-4 mb-2">
                    <div class="p-3 bg-indigo-600 rounded-2xl text-white shadow-lg shadow-indigo-200">
                        <i class="bi bi-tools text-2xl"></i>
                    </div>
                    <h1 class="text-4xl font-extrabold tracking-tight hero-gradient uppercase">Tool Architect</h1>
                </div>
                <p class="text-gray-500 text-lg font-medium">Design and generate custom capabilities for your agents</p>
            </div>
            <div class="flex items-center gap-4">
                <a class="btn btn-ghost border-gray-200 hover:bg-white px-6 font-bold" href="{{back_url}}">
                    <i class="bi bi-arrow-left"></i> Back to Source
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <main class="w-full">
            <div class="premium-card overflow-hidden">
                <div class="h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                <div class="p-8 md:p-12">
                    
                    {% if existing_tools %}
                    <div class="mb-12">
                        <div class="flex items-center gap-4 mb-6">
                            <span class="text-xs font-black text-indigo-500 uppercase tracking-widest">Global Modules</span>
                            <div class="h-px bg-gray-100 flex-grow"></div>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            {% for t in existing_tools %}
                            <a href="/tools/edit/{{ t.id }}" target="_blank" class="tool-badge">
                                <i class="bi bi-cpu-fill opacity-50"></i>
                                {{ t.name }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="flex items-center gap-4 mb-10">
                        <h2 class="text-xl font-extrabold uppercase tracking-wider text-gray-800">Configuration Blueprint</h2>
                        <div class="h-px bg-gray-100 flex-grow"></div>
                    </div>

                    {% if action == 'edit' %}
                    <form method="POST" action="{% url 'agentoapp:tools' action='edit' id=id %}" class="space-y-10">
                    {% else %}
                    <form method="POST" action="{% url 'agentoapp:tools' action='create' id=0 %}" class="space-y-10">
                    {% endif %}
                        {% csrf_token %}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-2">
                                <label for="toolName" class="block text-sm font-black text-gray-500 uppercase tracking-tight ml-1">
                                    Tool Identifier
                                </label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-400">
                                        <i class="bi bi-tag-fill"></i>
                                    </span>
                                    <input type="text" class="input-premium"
                                        id="toolName" name="toolName" placeholder="e.g., WeatherAPI_Scanner"
                                        value="{{tool.name}}" required>
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label for="modelSelect" class="block text-sm font-black text-gray-500 uppercase tracking-tight ml-1">
                                    Architectural Engine
                                </label>
                                <select class="select select-bordered w-full h-14 rounded-xl border-gray-300 font-semibold focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500" id="modelSelect" name="model">
                                    <option disabled selected value="">Select model...</option>
                                    {% for model in available_models %}
                                    <option value="{{ model }}" {% if model == "llama3.1:latest" %} selected="selected" {% endif %}>
                                        {{ model }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="space-y-8">
                            <div class="space-y-2">
                                <label for="context" class="flex items-center gap-2 text-sm font-black text-gray-500 uppercase tracking-tight ml-1">
                                    <i class="bi bi-info-circle-fill text-indigo-500"></i> Operational Context
                                </label>
                                <textarea class="textarea-premium" id="context" name="context"
                                    placeholder="Define the high-level purpose and constraints of this tool...">{{tool.context}}</textarea>
                            </div>

                            <div class="space-y-2">
                                <label for="instruction" class="flex items-center gap-2 text-sm font-black text-gray-500 uppercase tracking-tight ml-1">
                                    <i class="bi bi-gear-wide-connected text-purple-500"></i> Logical Requirements
                                </label>
                                <textarea class="textarea-premium" id="instruction" name="instruction"
                                    placeholder="Specify functional blocks, algorithms, and logic flow...">{{tool.instruction}}</textarea>
                            </div>

                            <div class="space-y-2">
                                <label for="outputFormatInstruction" class="flex items-center gap-2 text-sm font-black text-gray-500 uppercase tracking-tight ml-1">
                                    <i class="bi bi-braces text-pink-500"></i> Output Specification
                                </label>
                                <textarea class="textarea-premium" id="outputFormatInstruction" name="outputFormatInstruction"
                                    placeholder="Describe the target data structure (JSON/Markdown)...">{{tool.outputFormatInstruction}}</textarea>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-6 justify-between items-center pt-10 border-t border-gray-100">
                            <div class="flex items-center gap-3 text-gray-400 italic">
                                <i class="bi bi-shield-lock-fill text-lg"></i>
                                <span class="text-xs font-medium">Execution isolated in local sandbox environment</span>
                            </div>
                            <div class="flex gap-4 w-full sm:w-auto">
                                <button type="button" class="btn btn-neutral grow sm:grow-0 gap-2 h-14 px-8 rounded-xl shadow-lg border-none" id="generateCode">
                                    <i class="bi bi-magic text-yellow-400"></i> 
                                    <span>Generate Implementation</span>
                                </button>
                                <button type="submit" class="btn btn-primary grow sm:grow-0 gap-2 h-14 px-10 rounded-xl shadow-xl shadow-indigo-200 border-none bg-indigo-600 hover:bg-indigo-700" id="saveTool">
                                    <i class="bi bi-save2"></i>
                                    <span>Save Tool</span>
                                </button>
                            </div>
                        </div>

                        <!-- Code Editor Section -->
                        <div class="code-editor-container">
                            <div class="code-toolbar">
                                <div class="flex items-center gap-4">
                                    <div class="flex gap-1.5">
                                        <div class="w-3 h-3 rounded-full bg-red-400"></div>
                                        <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                                        <div class="w-3 h-3 rounded-full bg-green-400"></div>
                                    </div>
                                    <span class="text-[10px] font-black uppercase tracking-widest text-gray-400">Python Implementation</span>
                                </div>
                                <button type="button" class="btn btn-xs btn-ghost gap-2 font-bold text-gray-500 hover:text-indigo-600" id="copyCode">
                                    <i class="bi bi-clipboard"></i> Copy Logic
                                </button>
                            </div>
                            <textarea name="codeblock" id="codeEditor">{{tool.codeblock}}</textarea>
                        </div>

                        <input type="hidden" name="back_url" value="{{back_url}}" />
                    </form>
                </div>
            </div>
        </main>

        <footer class="mt-16 pb-8 text-center">
            <p class="text-[10px] font-black text-gray-300 uppercase tracking-[0.6em]">Agents on Tasks &copy; 2025</p>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

    <script>
        // Initialize CodeMirror
        var editor = CodeMirror.fromTextArea(document.getElementById("codeEditor"), {
            mode: "python",
            theme: "monokai",
            lineNumbers: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 4,
            tabSize: 4,
            lineWrapping: true,
            readOnly: false
        });

        // Generate Code button handler
        document.getElementById("generateCode").addEventListener("click", function () {
            const toolName = document.getElementById("toolName").value;
            const context = document.getElementById("context").value;
            const instruction = document.getElementById("instruction").value;
            const outputFormatInstruction = document.getElementById("outputFormatInstruction").value;
            const selectedModel = document.getElementById("modelSelect").value;

            if(!toolName) {
                alert("Please enter a Tool Identifier.");
                document.getElementById("toolName").focus();
                return;
            }

            const generateButton = document.getElementById("generateCode");
            generateButton.disabled = true;
            const originalHTML = generateButton.innerHTML;
            generateButton.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Generating...';

            fetch('/genai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    toolName: toolName,
                    context: context,
                    instruction: instruction,
                    outputFormatInstruction: outputFormatInstruction,
                    model: selectedModel
                })
            })
                .then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullResponse = '';

                    function processStream({ done, value }) {
                        if (done) {
                            editor.setValue(fullResponse);
                            generateButton.disabled = false;
                            generateButton.innerHTML = originalHTML;
                            return;
                        }

                        const chunk = decoder.decode(value, { stream: true });
                        fullResponse += chunk;
                        editor.setValue(fullResponse);
                        reader.read().then(processStream);
                    }

                    reader.read().then(processStream);
                })
                .catch(error => {
                    console.error('Error:', error);
                    generateButton.disabled = false;
                    generateButton.innerHTML = originalHTML;
                    alert('Generation failed. Check console.');
                });
        });

        // Copy Code button handler
        document.getElementById("copyCode").addEventListener("click", function () {
            const code = editor.getValue();
            navigator.clipboard.writeText(code).then(function () {
                const copyBtn = document.getElementById("copyCode");
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="bi bi-check2 text-green-500"></i> Copied!';
                setTimeout(() => { copyBtn.innerHTML = originalText; }, 2000);
            }).catch(function (err) {
                alert("Copy failed.");
            });
        });
    </script>
</body>

</html>